name: CI Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  validate:
    name: Validate Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify required files exist
        run: |
          echo "Checking for required files..."
          if [ ! -f "index.html" ]; then
            echo "Error: index.html not found"
            exit 1
          fi
          if [ ! -f "styles.css" ]; then
            echo "Error: styles.css not found"
            exit 1
          fi
          echo "Required files exist"

      - name: Check HTML files
        run: |
          echo "Checking HTML files..."
          for file in index.html blog.html bmiResult.html myStarterCodes/calculateBMI.html myStarterCodes/hompage.html; do
            if [ -f "$file" ]; then
              echo "Found: $file"
              # Basic HTML structure check
              if grep -q "<!DOCTYPE html>" "$file" || grep -q "<html" "$file"; then
                echo "   Valid HTML structure detected"
              fi
            else
              echo "File not found: $file (optional)"
            fi
          done

      - name: Check CSS file
        run: |
          echo "Checking CSS file..."
          if [ -f "styles.css" ]; then
            echo "styles.css found"
            # Check if file has content
            if [ -s "styles.css" ]; then
              echo "   File contains content"
            else
              echo "   File is empty"
            fi
          fi

      - name: Check JavaScript files
        run: |
          echo "Checking JavaScript files..."
          if [ -f "myStarterCodes/myJavaScriptFile.js" ]; then
            echo "myJavaScriptFile.js found"
          fi
          # Check for inline scripts in HTML
          if grep -r "<script>" *.html 2>/dev/null; then
            echo "Inline JavaScript found in HTML files"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install linting tools
        run: |
          npm install -g htmlhint stylelint stylelint-config-recommended eslint prettier
          npm list -g --depth=0

      - name: Lint HTML files
        run: |
          echo "Linting HTML files..."
          # Find and lint all HTML files
          HTML_ERRORS=0
          for file in $(find . -name "*.html" -type f -not -path "./.git/*"); do
            echo "Checking $file..."
            htmlhint "$file" || HTML_ERRORS=1
          done
          if [ $HTML_ERRORS -eq 1 ]; then
            echo "HTML linting failed. Please fix the errors above."
            exit 1
          fi
          echo "All HTML files passed linting!"

      - name: Lint CSS files
        run: |
          echo "Linting CSS files..."
          CSS_FILES=$(find . -name "*.css" -type f -not -path "./.git/*")
          if [ -z "$CSS_FILES" ]; then
            echo "No CSS files found to lint."
          else
            CSS_ERRORS=0
            for file in $CSS_FILES; do
              echo "Checking $file..."
              stylelint "$file" --formatter verbose || CSS_ERRORS=1
            done
            if [ $CSS_ERRORS -eq 1 ]; then
              echo "CSS linting failed. Please fix the errors above."
              exit 1
            fi
            echo "All CSS files passed linting!"
          fi

      - name: Lint JavaScript files
        run: |
          echo "Linting JavaScript files..."
          JS_FILES=$(find . -name "*.js" -type f -not -path "./.git/*")
          if [ -z "$JS_FILES" ]; then
            echo "No JavaScript files found to lint."
          else
            JS_ERRORS=0
            for file in $JS_FILES; do
              echo "Checking $file..."
              eslint "$file" --format stylish || JS_ERRORS=1
            done
            if [ $JS_ERRORS -eq 1 ]; then
              echo "JavaScript linting failed. Please fix the errors above."
              exit 1
            fi
            echo "All JavaScript files passed linting!"
          fi
          # Check for inline scripts in HTML files (warning only)
          if find . -name "*.html" -type f -exec grep -l "<script>" {} \; 2>/dev/null | grep -q .; then
            echo "Warning: Inline JavaScript found in HTML files (consider moving to external files)"
          fi

      - name: Check code formatting with Prettier
        run: |
          echo "Checking code formatting..."
          prettier --check "**/*.{html,css,js}" --ignore-path .prettierignore || {
            echo "Code formatting check failed. Run 'prettier --write .' to auto-fix formatting issues."
            exit 1
          }

      - name: Validate project structure
        run: |
          echo "Validating project structure..."
          echo "Project structure check complete"
          echo ""
          echo "Summary:"
          echo "- HTML files: Present"
          echo "- CSS files: Present"
          echo "- JavaScript files: Present"
          echo "- Linting checks completed"
          echo "- Formatting checks completed"
          echo "- All checks passed!"
